# drrrkari.com システム再構築およびデータフォレンジック 実装計画

## 目的
失われた「drrrkari.com」自動ログ収集システムの動作原理を、残されたデータアーティファクトから逆算（リバースエンジニアリング）し、再構築する。また、現存するデータセットを解析し、利用可能な形式で保存する。

## ユーザーレビュー要件
- **データ形式の特定**: 調査フェーズで発見されたデータ形式（HAR, JSON, HTML等）に基づき、解析アプローチを決定する際に確認を求める。
- **収集手法の選択**: Selenium（ブラウザ自動化）か APIラッパー（Requests）か、痕跡に基づいて決定した実装方針について合意を得る。

## 提案される変更

### 1. フォレンジック調査と環境定義
- **現状**: ユーザー要望により「巡回型（Patrol）」システムとして再構築。
- **アーキテクチャ**:
    - **動作**: ログイン -> ルーム一覧取得 -> 順番に入室 -> ログ取得 -> 退室 -> 次のルームへ
    - **保存形式**: JSON（サーバーのXMLレスポンスを変換して保存）
    - **認証**: PHP Session (Cookie), `POST /` (Login)

### 2. システム再構築 (Python)
#### [NEW] `patrol_bot.py` (Patrol Module)
- **ライブラリ**: `requests`, `lxml` (XMLパース), `json`
- **機能**:
    1. **Login**: ユーザー名・アイコンでログイン。
    2. **Discovery**: `/lounge` からルームIDリストを取得。
    3. **Patrol Loop**:
        - `POST /room` (Enter): ルームに入室。
        - `GET /ajax.php`: チャットログ（XML）を取得。
        - **Transform**: XML (`<talks>`, `<users>`) を JSON オブジェクトに変換。
        - **Save**: `logs/{room_id}_{timestamp}.json` に保存。
        - `POST /room?logout=1` (Leave): 退室（またはセッションリセット）。
        - **Sleep**: サーバー負荷軽減のため待機。

#### [NEW] `analyzer.py` (Analysis Module)
- **機能**: 保存された JSON ログの集計・分析。
- **実装詳細**:
    - JSON ファイルの読み込み。
    - ユーザーごとの発言数、活動時間の集計。
    - 特定ユーザー（UID/Icon）の追跡。
    - **出力**: 統合された CSV レポート。

## 検証計画

### 自動テスト
- **単体テスト**: パーサーがサンプルデータを正しく構造化データに変換できるか検証。
- **接続テスト**: `collector.py` が（もしサイトが現存すれば）ログインおよび入室に成功するか確認。

### 手動検証
- 生成された CSV/SQLite ファイルを開き、会話ログが人間可読な状態で復元されているか確認。
