# チャットログ収集・分析システム 実装計画

## 目的
drrrkari.comのチャットログを確実に収集し、ユーザー単位で分析できるシステムを構築します。

## 現状の課題
- 既存の並列ボットが部屋入室に失敗している
- サイトが多重ログインを検知してリダイレクトする
- 複雑なブラウザ自動化が不安定

## 提案する解決策

### アプローチ1: シンプルな単一セッション・ローテーションボット【推奨】

**概要**: 1つのブラウザセッションで順番に部屋を巡回し、ログを収集する

**メリット**:
- サイトの多重ログイン検知を回避
- 実装がシンプルで安定
- デバッグが容易

**実装**:

#### 1. シンプル巡回ボット (`simple_patrol.py`)
```python
基本動作:
1. ログイン
2. ルーム一覧取得
3. 各部屋に順番に入室 (5-10分滞在)
4. メッセージ収集 → Google Drive保存
5. 退室 → 次の部屋へ
6. 全部屋巡回後、最初に戻る
```

**特徴**:
- XMLレスポンスを直接パース (既存の[_handle_response](file:///c:/Users/admin/.gemini/antigravity/scratch/playwright_patrol_bot.py#34-44)ロジック流用)
- 増分保存 (重複排除)
- 日付別フォルダ: `G:\マイドライブ\開発関連\YYYY-MM-DD\log\`
- JSONフォーマット: `room_{id}_{name}.json`

#### 2. ログビューワー ([log_viewer.py](file:///c:/Users/admin/.gemini/antigravity/scratch/log_viewer.py))【既存】
- リアルタイム更新
- **ユーザー分析機能**: `encip`, `trip`, `uid`で横断検索
- URL: `http://localhost:5000`

---

### アプローチ2: 手動ログ収

集支援ツール【バックアップ案】

**概要**: ブラウザ拡張機能で手動でログを保存

**実装**: Chrome拡張機能でXMLレスポンスをキャプチャし、自動的にGoogle Driveフォルダに保存

---

## 推奨実装スケジュール

### フェーズ1: シンプル巡回ボット (優先度: 高)
1. `simple_patrol.py`作成
   - 既存の[parallel_patrol_bot.py](file:///c:/Users/admin/.gemini/antigravity/scratch/parallel_patrol_bot.py)から必要な機能を抽出
   - 単一セッション、順次入室ロジックに簡素化
   - 1部屋5分滞在、退室、次へ
2. 動作確認
   - 2-3部屋で実際にログが保存されるか検証

### フェーズ2: ビューワー最終調整
1. Google Driveパス確認: `G:\マイドライブ\開発関連\{日付}\log\`
2. ユーザー分析タブの動作確認

### フェーズ3: 24時間稼働テスト
1. ボット起動
2. ログ蓄積状況確認
3. エラー監視と修正

---

## 検証計画

### 自動テスト
- ログイン成功
- 部屋入室成功
- ログファイル生成確認

### 手動検証
- ビューワーでログ表示
- ユーザー検索機能テスト
- 24時間稼働後のログ容量確認

---

## ユーザーレビュー要件

> [!IMPORTANT]
> **アプローチの選択**
> - アプローチ1 (シンプル巡回ボット) を推奨します
> - もし手動収集 (アプローチ2) の方が良ければお知らせください

> [!WARNING]
> **制約事項**
> - サイトは多重ログインを検知するため、並列実行は不可
> - 1セッションでの順次巡回が最も確実
