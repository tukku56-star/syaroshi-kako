# drrrkari.com システム再構築およびデータフォレンジック 実装計画

## 目的
失われた「drrrkari.com」自動ログ収集システムの動作原理を、残されたデータアーティファクトから逆算（リバースエンジニアリング）し、再構築する。また、現存するデータセットを解析し、利用可能な形式で保存する。

## ユーザーレビュー要件
- **データ形式の特定**: 調査フェーズで発見されたデータ形式（HAR, JSON, HTML等）に基づき、解析アプローチを決定する際に確認を求める。
- **収集手法の選択**: Selenium（ブラウザ自動化）か APIラッパー（Requests）か、痕跡に基づいて決定した実装方針について合意を得る。

## 提案される変更

### 1. フォレンジック調査と環境定義
- **現状**: ユーザー提供の仕様書により、システムアーキテクチャが判明。
- **アーキテクチャ**:
    - **プロトコル**: HTTP/1.1, AJAX Polling (`ajax.php?fast=1`)
    - **データ形式**: XML (`<room>`, `<users>`, `<talks>`)
    - **認証**: PHP Session (Cookie), `POST /` (Login)
    - **ID生成**: `md5(name + ip)` (サーバー側処理)

### 2. システム再構築 (Python)
#### [NEW] `collector.py` (Ingestion Module)
- **ライブラリ**: `requests`, `lxml` (XMLパース用)
- **機能**:
    1. **Login**: `POST /` に `name`, `icon`, `language` を送信。Cookieを保持。
    2. **Lounge**: `GET /lounge` からルーム一覧（HTML/XML）を取得。
    3. **Enter Room**: `POST /room` (ID送信) で入室。
    4. **Polling**: `GET /ajax.php?fast=1` を 1.5秒間隔でループ。
    5. **Parsing**: レスポンスの XML をパースし、`<talk>` 要素を抽出。

#### [NEW] `parser.py` (Forensic Module)
- **機能**: 過去のログデータ（XML形式と想定）の解析。
- **実装詳細**:
    - `lxml` を使用して `<talk>` ノードを抽出。
    - 属性: `id`, `uid`, `name`, `message`, `icon`, `time`。
    - **スパムフィルタ**: メッセージ本文が `jump.php` のみのエントリを除外。
    - **出力**: SQLite データベース (`logs.db`)。

## 検証計画

### 自動テスト
- **単体テスト**: パーサーがサンプルデータを正しく構造化データに変換できるか検証。
- **接続テスト**: `collector.py` が（もしサイトが現存すれば）ログインおよび入室に成功するか確認。

### 手動検証
- 生成された CSV/SQLite ファイルを開き、会話ログが人間可読な状態で復元されているか確認。
